name: iOS Tests

on:
  pull_request:
    branches: [ main, develop ] # ajusta para os branches que quiser monitorar
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macOS-latest

    steps:
      - name: Checkout repository
#        uses: actions/checkout@v4
        uses: actions/checkout@v1
#
#      - name: Set up Ruby
#        uses: ruby/setup-ruby@v1
#        with:
#          ruby-version: 3.2 # Ajusta para a versão que você usa no projeto

#      - name: Install dependencies
#        run: |
#          gem install bundler
#          bundle install

      - name: Bundle Install
        run: bundle install

      # - name: Ensure iOS Simulator is available
      #   run: sudo xcode-select -s /Applications/Xcode_16.app

      - name: Run tests with Fastlane
        id: run_tests
        run: bundle exec fastlane tests
      
      - name: Send Discord Notification
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="✅ Success"
          # Verifica se o passo 'run_tests' falhou
          if [ "${{ steps.run_tests.conclusion }}" != "success" ]; then
            STATUS="❌ Failed value:${{ steps.run_tests.conclusion }}"
          fi

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\": \"iOS Tests completed: $STATUS\nRepository: $GITHUB_REPOSITORY\nPR: $GITHUB_REF\"}" \
              "$WEBHOOK_URL"


